---
title: "Untitled"
output: html_document
---
# Prerequisites

Packages:

```{r}
# Helper packages
library(dplyr)     # for data wrangling
library(ggplot2)   # for awesome plotting

# Modeling packages
library(earth)     # for fitting MARS models
library(caret)     # for automating the tuning process

# Model interpretability packages
library(vip)       # for variable importance
library(pdp)       # for variable relationships
library(rsample)
```
Data:
```{r}
# Hitters data

data(Hitters, package = "ISLR")
# initial dimension
dim(Hitters)

# response variable
head(Hitters$Salary)

#Delete NA
Hitters <- na.omit(Hitters)

# split data
set.seed(123)
split <- initial_split(Hitters, strata = "Salary",prop = 0.7)
hitters_train <- training(split)

```

#Quistion
*Apply a MARS model with all features.
*How does the model performance compare to your previous models?
```{r}
caret::getModelInfo("earth")$earth$parameters
```
```{r}
# Fit a basic MARS model
mars1 <- earth(
  Salary ~ .,  
  data = hitters_train   
)

# Print model summary
print(mars1)
```
*How many of the features are influential? Which 10 features are considered most influential?
```{r}
summary(mars1) %>% .$coefficients %>% head(10)
```

*Does your model include hinge functions? If so, explain their coefficient and plot their impact on the predicted response variable.

```{r cv-mars}
# tuning grid
hyper_grid <- expand.grid(
  nprune = seq(2, 50, length.out = 10) %>% floor(),
  degree = 1:3
)

# perform resampling
set.seed(123)
cv_mars <- train(
  Salary ~ ., 
  data = hitters_train, 
  trControl = trainControl(method = "cv", number = 10),
  method = "earth", #<<
  tuneGrid = hyper_grid,
  metric = "RMSE"
  )

# best model
cv_mars$results %>%
  filter(
    nprune == cv_mars$bestTune$nprune,
    degree == cv_mars$bestTune$degree
    )

# plot results
plot(cv_mars)
```



```{r}
# variable importance plots
p1 <- vip(cv_mars, num_features = 40, geom = "point", value = "gcv") + ggtitle("GCV")
p2 <- vip(cv_mars, num_features = 40, geom = "point", value = "rss") + ggtitle("RSS")

gridExtra::grid.arrange(p1, p2, ncol = 2)
```

*Does your model include interactions? If so, pick the interaction effect that is most influential and explain the coefficient.
```{r pdp, fig.width=15, fig.height=3, warning=FALSE, message=FALSE}
# Construct partial dependence plots
p1 <- partial(cv_mars, pred.var = "CRBI", grid.resolution = 10) %>% 
  ggplot(aes(CRBI, yhat)) +
  geom_line()

p2 <- partial(cv_mars, pred.var = "Years", grid.resolution = 10) %>% 
  ggplot(aes(Years, yhat)) +
  geom_line()
p3 <- partial(cv_mars, pred.var = c("CRBI", "Years"), 
              grid.resolution = 10) %>% 
  plotPartial(levelplot = FALSE, zlab = "yhat", drape = TRUE, colorkey = TRUE, 
              screen = list(z = -20, x = -60))
# Display plots side by side
gridExtra::grid.arrange(p1, p2, p3, ncol = 3)
```


